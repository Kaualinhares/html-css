<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MundoTEA - Meu Perfil</title>
    <link rel="icon" type="image/png" href="imagens/logo_mundotea.png">
    <link rel="stylesheet" href="css/estilo.css">
</head>
<body>

<header class="header">
    <div class="logo">
        <img src="imagens/logo_mundotea.png" alt="Logo MundoTEA">
        <h1 class="titulo-site"><span class="mundo">Mundo</span><span class="tea">TEA</span></h1>
    </div>
</header>

<main class="perfil-container">

    <h2 class="perfil-titulo">Meu Perfil</h2>

    <div class="perfil-bloco">

        <section class="perfil-informacoes">
            <h3 class="perfil-subtitulo">Informa√ß√µes Pessoais</h3>

            <div class="perfil-info-conteudo">

                <div class="perfil-foto">
                    <img src="imagens/iconegenerico.png" alt="Foto do Usu√°rio">
                </div>

                <div class="perfil-dados">

                    <label>Nome da Crian√ßa:</label>
                    <input type="text" id="nomeUsuario" disabled>

                    <label>Email do Usu√°rio:</label>
                    <input type="text" id="emailUsuario" disabled>

                    <label>Data de Nascimento:</label>
                    <input type="date" id="nascimento" disabled>

                    <label>N√≠vel de Autismo:</label>
                    <select id="progresso" disabled>
                        <option value="1">N√≠vel 1</option>
                        <option value="2">N√≠vel 2</option>
                        <option value="3">N√≠vel 3</option>
                    </select>

                    <label>Nome do Pai:</label>
                    <input type="text" id="nomePai" disabled>

                    <label>Nome da M√£e:</label>
                    <input type="text" id="nomeMae" disabled>

                    <label>Telefone do Respons√°vel:</label>
                    <input type="text" id="telefoneResp" disabled>

                    <label>Email do Respons√°vel:</label>
                    <input type="text" id="emailResp" disabled>

                    <!-- BOT√ïES NOVOS -->
                    <div class="perfil-botoes">
                        <button id="btnEditar" class="btn-perfil editar">Alterar Informa√ß√µes</button>
                        <button id="btnSalvar" class="btn-perfil salvar" style="display:none;">Salvar Altera√ß√µes</button>
                        <button id="btnLogout" class="btn-perfil sair">Sair</button>
                    </div>

                </div>
            </div>
        </section>

        <!-- MINHAS CONQUISTAS (opcional) -->
        <section class="perfil-conquistas">
            <h3 class="perfil-subtitulo">Minhas Conquistas üèÖ</h3>
            <div class="conquistas-grid">
                <div class="conquista-card"><img src="imagens/crie-sua-historia.jpg"><p>10 Hist√≥rias Lidas</p></div>
                <div class="conquista-card"><img src="imagens/icone-quebra-cabeca.png"><p>5 Quebra-Cabe√ßas Montados</p></div>
                <div class="conquista-card"><img src="imagens/pintura.jpg"><p>20 Desenhos Coloridos</p></div>
                <div class="conquista-card"><img src="imagens/foguete-universo.jpg"><p>Primeira Aventura</p></div>
                <div class="conquista-card"><img src="imagens/memoria.png"><p>Miss√£o Cumprida!</p></div>
                <div class="conquista-card"><img src="imagens/quebra-cabeca.jpg"><p>Amigo TEA</p></div>
            </div>
        </section>

    </div>

    <div class="voltar-container">
        <a href="index.html" class="btn-voltar">Voltar ao Menu</a>
    </div>
</main>

<script>
// Fun√ß√£o para habilitar campos
function habilitarCampos() {
    const campos = [
        'nomeUsuario', 'nascimento', 'progresso',
        'nomePai', 'nomeMae', 'telefoneResp', 'emailResp'
    ];

    campos.forEach(id => document.getElementById(id).disabled = false);

    // Alternar bot√µes
    document.getElementById('btnEditar').style.display = "none";
    document.getElementById('btnSalvar').style.display = "inline-block";
}

// Carregar perfil do backend
async function carregarPerfil() {
    const token = localStorage.getItem('token');
    if (!token) {
        alert('Fa√ßa login para acessar o perfil.');
        window.location.href = 'index.html';
        return;
    }

    try {
        const res = await fetch('http://localhost:5000/perfil', {
            headers: { 'Authorization': 'Bearer ' + token }
        });

        const data = await res.json();

        if (res.ok) {
            document.getElementById('nomeUsuario').value = data.nome_crianca || '';
            document.getElementById('emailUsuario').value = data.email_login || '';
            document.getElementById('nascimento').value = data.data_nascimento ? data.data_nascimento.split('T')[0] : '';
            document.getElementById('progresso').value = data.nivel_autismo || 1;
            document.getElementById('nomePai').value = data.nome_pai || '';
            document.getElementById('nomeMae').value = data.nome_mae || '';
            document.getElementById('telefoneResp').value = data.telefone_responsavel || '';
            document.getElementById('emailResp').value = data.email_responsavel || '';
        } else {
            alert(data.erro || 'Erro ao carregar perfil');
        }

    } catch (err) {
        console.error(err);
        alert('Erro ao conectar √† API');
    }
}

// Fun√ß√£o para salvar no backend
async function salvarAlteracoes() {
    const token = localStorage.getItem('token');
    if (!token) {
        alert('Fa√ßa login para acessar o perfil.');
        window.location.href = 'index.html';
        return;
    }

    const dados = {
        nome: document.getElementById('nomeUsuario').value,
        data_nascimento: document.getElementById('nascimento').value,
        nivel_autismo: parseInt(document.getElementById('progresso').value),
        nome_pai: document.getElementById('nomePai').value,
        nome_mae: document.getElementById('nomeMae').value,
        telefone_responsavel: document.getElementById('telefoneResp').value,
        email_responsavel: document.getElementById('emailResp').value
    };

    try {
        const res = await fetch('http://localhost:5000/perfil/atualizar', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(dados)
        });

        const data = await res.json();

        if (res.ok) {
            alert('Altera√ß√µes salvas com sucesso!');

            const campos = [
                'nomeUsuario', 'nascimento', 'progresso',
                'nomePai', 'nomeMae', 'telefoneResp', 'emailResp'
            ];

            campos.forEach(id => document.getElementById(id).disabled = true);

            document.getElementById('btnSalvar').style.display = "none";
            document.getElementById('btnEditar').style.display = "inline-block";

        } else {
            alert(data.erro || 'Erro ao salvar altera√ß√µes');
        }

    } catch (err) {
        console.error(err);
        alert('Erro ao conectar √† API');
    }
}

// Eventos
document.getElementById('btnEditar').addEventListener('click', habilitarCampos);
document.getElementById('btnSalvar').addEventListener('click', salvarAlteracoes);
document.getElementById('btnLogout').addEventListener('click', () => {
    localStorage.removeItem('token');
    localStorage.removeItem('login_id');
    window.location.href = 'index.html';
});

window.onload = carregarPerfil;
</script>

</body>
</html>
