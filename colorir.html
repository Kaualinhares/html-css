<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MundoTEA - Colorir</title>
<link rel="icon" type="image/png" href="imagens/logo_mundotea.png">
<link rel="stylesheet" href="css/estilo.css">
</head>
<body>
<header class="header">
    <div class="logo">
        <img src="imagens/logo_mundotea.png" alt="Logo MundoTEA">
        <h1 class="titulo-site"><span class="mundo">Mundo</span><span class="tea">TEA</span></h1>
    </div>
</header>

<main class="colorir-container">
    <section class="colorir-titulo-area">
        <h1>üé® Criar & Colorir</h1>
    </section>

    <div class="colorir-conteudo">
        <!-- LISTA DE DESENHOS -->
        <aside class="colorir-desenhos-lista">
            <div class="colorir-desenho-item">
                <img src="imagens/foguete-colorir.jpg" data-img="imagens/foguete-colorir.jpg">
                <button class="colorir-btn-escolher">Escolher</button>
            </div>
            <div class="colorir-desenho-item">
                <img src="imagens/castelo-colorir.jpg" data-img="imagens/castelo-colorir.jpg">
                <button class="colorir-btn-escolher">Escolher</button>
            </div>
            <div class="colorir-desenho-item">
                <img src="imagens/monstro-colorir.jpg" data-img="imagens/monstro-colorir.jpg">
                <button class="colorir-btn-escolher">Escolher</button>
            </div>
            <div class="colorir-desenho-item">
                <img src="imagens/reino-colorir.jpg" data-img="imagens/reino-colorir.jpg">
                <button class="colorir-btn-escolher">Escolher</button>
            </div>
        </aside>

        <!-- CANVAS -->
        <section class="colorir-area-desenho">
            <canvas id="canvas-desenho" width="500" height="500"></canvas>
            <div class="voltar-container">
                <a href="index.html" class="btn-voltar">Voltar ao Menu</a>
            </div>
        </section>

        <!-- FERRAMENTAS -->
        <aside class="colorir-ferramentas">
            <div class="colorir-icones">
                <button id="btnPincel" class="colorir-btn-escolher">üñåÔ∏è Pincel</button>
                <button id="btnLapis" class="colorir-btn-escolher">‚úèÔ∏è L√°pis</button>
            </div>

            <div class="colorir-paleta">
                <span class="cor" data-cor="#ff0000" style="background:#ff0000"></span>
                <span class="cor" data-cor="#ff6600" style="background:#ff6600"></span>
                <span class="cor" data-cor="#ffff00" style="background:#ffff00"></span>
                <span class="cor" data-cor="#00cc00" style="background:#00cc00"></span>
                <span class="cor" data-cor="#0066ff" style="background:#0066ff"></span>
                <span class="cor" data-cor="#ff66b2" style="background:#ff66b2"></span>
                <span class="cor" data-cor="#cc33ff" style="background:#cc33ff"></span>
                <span class="cor" data-cor="#00ffff" style="background:#00ffff"></span>
                <span class="cor" data-cor="#ffaa00" style="background:#ffaa00"></span>
                <span class="cor" data-cor="#000000" style="background:#000000"></span>
                <span class="cor" data-cor="#ffffff" style="background:#ffffff; border:1px solid #ccc"></span>
                <span class="cor" data-cor="#888888" style="background:#888888"></span>
                <span class="cor" data-cor="#663300" style="background:#663300"></span>
                <span class="cor" data-cor="#ff9999" style="background:#ff9999"></span>
                <span class="cor" data-cor="#9999ff" style="background:#9999ff"></span>
            </div>

            <button id="btnDesfazer" class="colorir-btn-acao azul">‚Ü©Ô∏è Desfazer</button>
            <button id="btnSalvar" class="colorir-btn-acao verde">üíæ Salvar</button>
        </aside>
    </div>
</main>

<script>
const canvas = document.getElementById("canvas-desenho");
const ctx = canvas.getContext("2d");

// ======== VARI√ÅVEIS ========
let desenhando = false;
let corAtual = "#000000";
let modo = "pincel";
let imagemAtual = new Image();
let historico = [];
let tempo = 0;
let intervalo = null;
let cronometroIniciado = false;

// SESS√ÉO API
let sessaoId = null;
const atividadeId = 2; // Criar & Colorir

// Bot√£o salvar
const btnSalvar = document.getElementById("btnSalvar");
btnSalvar.disabled = true; // desabilitado at√© iniciar sess√£o

// ======== FUN√á√ïES ========

// Salva estado para desfazer
function salvarEstado() {
    historico.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
    if (historico.length > 30) historico.shift();
}

// Carrega desenho no canvas
function carregarDesenho(src) {
    imagemAtual.src = src;
    imagemAtual.onload = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(imagemAtual, 0, 0, canvas.width, canvas.height);
        historico = [];
        salvarEstado();
    };
}

// Inicia cron√¥metro
function iniciarCronometro() {
    if (!cronometroIniciado) {
        cronometroIniciado = true;
        intervalo = setInterval(() => { tempo++; }, 1000);
    }
}

// ======== SESS√ÉO ========

// Inicia sess√£o no backend automaticamente
async function iniciarSessao() {
    const token = localStorage.getItem("token");
    if (!token) return alert("Voc√™ precisa estar logado para usar o colorir.");

    try {
        const res = await fetch("http://localhost:5000/sessoes", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token 
            },
            body: JSON.stringify({ atividade_id: atividadeId })
        });
        const data = await res.json();

        if (data.sessao_id) {
            sessaoId = data.sessao_id;
            btnSalvar.disabled = false; // habilita salvar
            console.log("Sess√£o iniciada:", sessaoId);
        } else {
            alert("N√£o foi poss√≠vel iniciar a sess√£o.");
        }
    } catch (err) {
        console.error("Erro ao iniciar sess√£o:", err);
    }
}

// Finaliza sess√£o e salva imagem
async function finalizarSessao() {
    const token = localStorage.getItem("token");
    if (!token || !sessaoId) return alert("Sess√£o n√£o iniciada.");

    const imagemBase64 = canvas.toDataURL();

    try {
        // Atualiza sess√£o
        await fetch("http://localhost:5000/sessoes/atualizar", {
            method: "PUT",
            headers: { 
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token 
            },
            body: JSON.stringify({
                sessao_id: sessaoId,
                tempo_gasto_segundos: tempo,
                score: 1,
                acuracia: 100
            })
        });

        // Salva imagem
        await fetch("http://localhost:5000/sessoes/salvar_imagem", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify({
                sessao_id: sessaoId,
                imagem: imagemBase64
            })
        });

        alert("Sess√£o e imagem salvas com sucesso!");
    } catch (err) {
        console.error("Erro ao salvar sess√£o:", err);
    }
}

// ======== EVENTOS ========

// Escolher desenho
document.querySelectorAll(".colorir-btn-escolher").forEach(btn => {
    btn.onclick = () => {
        const img = btn.parentElement.querySelector("img").dataset.img;
        carregarDesenho(img);
    };
});

// Paleta de cores
document.querySelectorAll(".cor").forEach(c => {
    c.onclick = () => { corAtual = c.dataset.cor; modo = "pincel"; };
});

// Ferramentas
document.getElementById("btnPincel").onclick = () => modo = "pincel";
document.getElementById("btnLapis").onclick = () => modo = "lapis";

// Desfazer
document.getElementById("btnDesfazer").onclick = () => {
    if (historico.length > 1) {
        historico.pop();
        const estado = historico[historico.length - 1];
        ctx.putImageData(estado, 0, 0);
    }
};

// Salvar
btnSalvar.onclick = finalizarSessao;

// Eventos do canvas
canvas.onmousedown = () => { iniciarCronometro(); salvarEstado(); desenhando = true; };
canvas.onmouseup = () => { desenhando = false; ctx.beginPath(); };
canvas.onmouseleave = () => { desenhando = false; ctx.beginPath(); };
canvas.onmousemove = (e) => {
    if (!desenhando) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    ctx.lineCap = "round";
    ctx.strokeStyle = corAtual;
    ctx.lineWidth = (modo === "pincel") ? 12 : 5;
    ctx.globalCompositeOperation = "source-over";
    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
};

// ======== INICIALIZA√á√ÉO ========
window.onload = async () => {
    carregarDesenho("imagens/monstro-colorir.jpg"); // desenho inicial
    await iniciarSessao(); // cria sess√£o automaticamente ao entrar
};
</script>

</body>
</html>
