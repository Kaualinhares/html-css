<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="imagens/logo_mundotea.png">
  <title>MundoTEA - Jogo da Memória</title>
  <link rel="stylesheet" href="css/estilo.css">
</head>

<body>

  <!-- Cabeçalho -->
  <header class="header">
    <div class="logo">
      <img src="imagens/logo_mundotea.png" alt="Logo MundoTEA">
      <h1 class="titulo-site"><span class="mundo">Mundo</span><span class="tea">TEA</span></h1>
    </div>
    <div class="user-actions">
      <a href="perfil.html" class="profile-icon">
        <img src="imagens/iconegenerico.png" alt="Perfil Usuário">
      </a>
    </div>
  </header>

  <main class="memoria-container">

    <header class="memoria-header">
      <img src="imagens/memoriapng.png" alt="Ícone Memória" class="memoria-icone">
      <h1>Jogo da Memória</h1>
    </header>

    <div class="memoria-timer">Tempo: <span id="timer">00:00</span></div>
    <div class="memoria-controls">
      <button id="btnReiniciar" class="btn-jogar">Reiniciar Jogo</button>
    </div>

    <section class="memoria-grid" id="memoriaGrid">
      <!-- As cartas serão geradas via JS -->
    </section>

    <div class="voltar-container">
      <a href="jogos-ludicos.html" class="btn-voltar">Voltar ao menu</a>
    </div>

  </main>

<script>
let grid = document.getElementById("memoriaGrid");
let tempo = 0;
let intervalo = null;
let cronometroIniciado = false;
let primeira = null;
let segunda = null;
let travar = false;

let sessaoId = null;
const atividadeId = 2; // ID da atividade "Jogo da Memória" na sua tabela

// Lista de animais
const animais = ["leao","flamingo","tartaruga","girafa","elefante","macaco"];

// Função para criar o deck duplicando cartas
function criarDeck() {
    return [...animais, ...animais].map(animal => {
        const card = document.createElement("div");
        card.classList.add("memoria-card");
        card.dataset.animal = animal;
        card.innerHTML = `
            <div class="memoria-card-inner">
                <div class="memoria-front"></div>
                <div class="memoria-back">
                    <img src="imagens/${animal}.jpg" alt="${animal}">
                    <span class="memoria-nome">${animal.charAt(0).toUpperCase() + animal.slice(1)}</span>
                </div>
            </div>
        `;
        return card;
    });
}

// Embaralhar
function embaralharDeck(array) {
    return array.sort(() => Math.random() - 0.5);
}

// Renderiza grid
function renderizarGrid() {
    grid.innerHTML = "";
    const deck = embaralharDeck(criarDeck());
    deck.forEach(card => {
        card.addEventListener("click", () => virar(card));
        grid.appendChild(card);
    });
}

// Cronômetro
function iniciarCronometro() {
    intervalo = setInterval(() => {
        tempo++;
        let m = String(Math.floor(tempo / 60)).padStart(2, "0");
        let s = String(tempo % 60).padStart(2, "0");
        document.getElementById("timer").textContent = `${m}:${s}`;
    }, 1000);
}

// Virar carta
function virar(card) {
    if (!cronometroIniciado) {
        cronometroIniciado = true;
        iniciarCronometro();
    }
    if (travar || card.classList.contains("virada") || card.classList.contains("matched")) return;

    card.classList.add("virada");

    if (!primeira) {
        primeira = card;
    } else {
        segunda = card;
        travar = true;

        if (primeira.dataset.animal === segunda.dataset.animal) {
            setTimeout(() => {
                primeira.classList.add("matched");
                segunda.classList.add("matched");
                primeira = null;
                segunda = null;
                travar = false;

                if ([...grid.children].every(c => c.classList.contains("matched"))) {
                    clearInterval(intervalo);
                    finalizarSessaoMemoria();
                }
            }, 600);
        } else {
            setTimeout(() => {
                primeira.classList.remove("virada");
                segunda.classList.remove("virada");
                primeira = null;
                segunda = null;
                travar = false;
            }, 900);
        }
    }
}

// Inicia sessão API
async function iniciarSessaoMemoria() {
    const token = localStorage.getItem("token");
    if (!token) return;
    try {
        const res = await fetch("http://localhost:5000/sessoes", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify({ atividade_id: atividadeId })
        });
        const data = await res.json();
        sessaoId = data.sessao_id;
        console.log("Sessão iniciada:", sessaoId);
    } catch (err) {
        console.error("Erro ao iniciar sessão:", err);
    }
}

// Finaliza sessão
async function finalizarSessaoMemoria() {
    if (!sessaoId) return;
    const token = localStorage.getItem("token");
    if (!token) return;
    const score = [...grid.children].filter(c => c.classList.contains("matched")).length;
    try {
        await fetch("http://localhost:5000/sessoes/atualizar", {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify({
                sessao_id: sessaoId,
                tempo_gasto_segundos: tempo,
                score: score,
                acuracia: 100
            })
        });
        console.log("Sessão atualizada!");
    } catch (err) {
        console.error("Erro ao atualizar sessão:", err);
    }
}

// Reiniciar jogo
document.getElementById("btnReiniciar").addEventListener("click", () => {
    clearInterval(intervalo);
    cronometroIniciado = false;
    tempo = 0;
    document.getElementById("timer").textContent = "00:00";
    primeira = null;
    segunda = null;
    travar = false;
    renderizarGrid();
    iniciarSessaoMemoria();
});

// Inicializa
window.onload = () => {
    renderizarGrid();
    iniciarSessaoMemoria();
};
</script>

</body>
</html>
